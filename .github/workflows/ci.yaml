name: CI
on: [push, pull_request]
jobs:
  build:
    strategy:
      matrix:
        python-version: [
          "dev-lang/python-3.9",
          "dev-lang/python-3.10",
          "dev-lang/python-3.11",
          "dev-lang/python-3.12",
          "dev-python/pypy3-7"
        ]
      fail-fast: false
    runs-on: ubuntu-latest
    container:
      image: gentoo/stage3
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Cache
        uses: actions/cache@v3
        with:
          path: /var/cache/binpkgs
          key: ${{ runner.os }}-${{ hashFiles('**/tox.ini') }}
          restore-keys: |
            ${{ runner.os }}-
      - name: Install deps
        run: |
          echo 'FEATURES="-ipc-sandbox -pid-sandbox -network-sandbox -usersandbox -mount-sandbox -sandbox"' | cat >> /etc/portage/make.conf
          # userpriv is for the tests (Portage needs to source the ebuilds in a root-owned dir here)
          echo 'FEATURES="${FEATURES} -userpriv"' | cat >> /etc/portage/make.conf
          echo 'FEATURES="${FEATURES} buildpkg parallel-install parallel-fetch -merge-sync"' | cat >> /etc/portage/make.conf
          echo -e "[binhost]\npriority = 9999\nsync-uri = https://gentoo.osuosl.org/experimental/amd64/binpkg/default/linux/17.1/x86-64/\n" | cat >> /etc/portage/binrepos.conf
          echo 'EMERGE_DEFAULT_OPTS="--binpkg-respect-use=n --usepkg=y --getbinpkg=y --autounmask-write --autounmask-continue --autounmask-keep-keywords=y --autounmask-use=y"' | cat >> /etc/portage/make.conf

          echo '=${{matrix.python-version}}*' | cat >> /etc/portage/package.accept_keywords/python

          emerge-webrsync --quiet
          emerge --quiet --noreplace =${{matrix.python-version}}*
          emerge --quiet --noreplace dev-python/tox
      - name: Test using tox
        run: tox -e py
